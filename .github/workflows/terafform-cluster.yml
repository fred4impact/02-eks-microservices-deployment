name: Terraform EKS Cluster Provisioning on AWS

on:
    workflow_dispatch:
        inputs:
            tfvars_file:
                description: "The Terraform variables file to use"
                required: true
                default: "dev.tfvars"
            env:
                description: "The environment to deploy to"
                required: true
                default: "development"
            action:
                description: "Terraform actions to perform (plan, apply, destroy)"
                type: choice
                options:
                    - plan
                    - apply
                    - destroy
                required: true
                default: "plan"

env:
    AWS_REGION: us-east-1
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

permissions:
    contents: read

jobs:
    terraform:
        name: Terraform ${{ github.event.inputs.action }}
        runs-on: ubuntu-latest
        environment: ${{ github.event.inputs.env }}

        defaults:
            run:
                shell: bash
                working-directory: setup-eks-cluster

        steps:
            - name: Checkout Reporsitory
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_wrapper: true

            # Optional: Enable caching to speed up init
            - name: Cache Terraform
              uses: actions/cache@v4
              id: terraform-cache
              with:
                  path: |
                      ~/.terraform.d/plugin-cache
                      setup-eks-cluster/.terraform
                  key: ${{ runner.os }}-terraform-${{ hashFiles('setup-eks-cluster/**/*.tf', 'module/**/*.tf') }}
                  restore-keys: |
                      ${{ runner.os }}-terraform-
                  if-no-files-found: ignore

            - name: Initialize Terraform
              run: terraform init

            - name: Format Terraform syntax
              run: terraform fmt -check -diff

            - name: Validate Terraform Code
              run: terraform validate

            - name: Verify tfvars file exists
              run: |
                  if [ ! -f "${{ github.event.inputs.tfvars_file }}" ]; then
                      echo "Error: File ${{ github.event.inputs.tfvars_file }} not found in $(pwd)"
                      ls -la
                      exit 1
                  fi
                  echo "Found tfvars file: ${{ github.event.inputs.tfvars_file }}"

            - name: Terraform Plan
              if: ${{ github.event.inputs.action == 'plan' }}
              run: |
                  terraform plan -var-file=./${{ github.event.inputs.tfvars_file }} -input=false

            - name: Terraform Apply
              if: ${{ github.event.inputs.action == 'apply' }}
              run: |
                  terraform apply -auto-approve -var-file=./${{ github.event.inputs.tfvars_file }} -input=false

            - name: Terraform Destroy
              if: ${{ github.event.inputs.action == 'destroy' }}
              run: |
                  terraform destroy -auto-approve -var-file=./${{ github.event.inputs.tfvars_file }} -input=false
